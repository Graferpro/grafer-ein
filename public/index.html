    <script>
        const chatWidget = document.getElementById('chat-widget');
        const messagesArea = document.getElementById('chat-messages');
        const startOptions = document.getElementById('start-options');
        let messageHistory = [];

        function openChat() { chatWidget.classList.remove('hidden'); }
        function closeChat() { chatWidget.classList.add('hidden'); }

        function selectOption(option) {
            startOptions.style.display = 'none';
            document.getElementById('user-input').value = option;
            sendMessage();
        }

        async function sendMessage() {
            const input = document.getElementById('user-input');
            const msg = input.value;
            if(!msg.trim()) return;

            // Mesajı Ekrana Bas
            messagesArea.innerHTML += `
                <div class="flex justify-end animate-[fadeIn_0.3s] mb-4">
                    <div class="bg-emerald-600 p-3 rounded-2xl rounded-tr-none text-sm text-white shadow-md max-w-[85%]">
                        ${msg}
                    </div>
                </div>`;
            input.value = '';
            messagesArea.scrollTop = messagesArea.scrollHeight;
            messageHistory.push({ role: "user", content: msg });

            // Yükleniyor...
            const loadingId = 'loading-' + Date.now();
            messagesArea.innerHTML += `
                <div id="${loadingId}" class="flex gap-3 animate-[fadeIn_0.3s] mb-4">
                    <div class="bg-slate-800 p-3 rounded-2xl rounded-tl-none text-sm text-slate-400 border border-slate-700">
                        Processing...
                    </div>
                </div>`;
            messagesArea.scrollTop = messagesArea.scrollHeight;

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messages: messageHistory })
                });

                const data = await response.json();
                document.getElementById(loadingId).remove();

                // --- SİHİRLİ KISIM: GİZLİ KODU ARA ---
                let botReply = data.reply;
                
                if (botReply.includes("###JSON_START###")) {
                    // Gizli kodu ayıkla
                    const parts = botReply.split("###JSON_START###");
                    const realMessage = parts[0]; 
                    const jsonPart = parts[1].split("###JSON_END###")[0];

                    botReply = realMessage; // Ekrana temiz mesajı bas

                    // PDF MOTORUNU ÇALIŞTIR!
                    downloadPDF(JSON.parse(jsonPart));
                }
                // -------------------------------------

                // Cevabı Ekrana Bas
                messagesArea.innerHTML += `
                <div class="flex gap-3 animate-[fadeIn_0.3s] mb-4">
                    <div class="w-8 h-8 rounded-full bg-gray-200 border border-emerald-500 overflow-hidden flex-shrink-0 mt-1">
                         <img src="https://ui-avatars.com/api/?name=Michael+Agent&background=fff&color=059669&size=128">
                    </div>
                    <div class="bg-slate-800 p-3 rounded-2xl rounded-tl-none text-sm text-slate-200 border border-slate-700 shadow-sm">
                        ${botReply}
                    </div>
                </div>`;
                
                messageHistory.push({ role: "assistant", content: data.reply });

            } catch (error) {
                document.getElementById(loadingId)?.remove();
                messagesArea.innerHTML += `<div class="text-red-400 text-xs text-center">Hata oluştu.</div>`;
            }
            messagesArea.scrollTop = messagesArea.scrollHeight;
        }

        // PDF İNDİRME FONKSİYONU
        async function downloadPDF(formData) {
            messagesArea.innerHTML += `
                <div class="flex justify-center mb-4 animate-bounce">
                    <div class="bg-emerald-900/50 text-emerald-400 text-xs px-4 py-2 rounded-full border border-emerald-500/30 flex items-center gap-2">
                        <i class="fas fa-file-pdf"></i> Form Hazırlanıyor...
                    </div>
                </div>`;
            messagesArea.scrollTop = messagesArea.scrollHeight;

            try {
                // PDF Motoruna Verileri Gönder
                const response = await fetch('/api/generate-pdf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = "Basvuru_Formu_SS4.pdf";
                    document.body.appendChild(a);
                    a.click();
                    a.remove();
                } else {
                    alert("PDF Hatası! Lütfen tekrar deneyin.");
                }
            } catch (e) {
                console.error(e);
            }
        }
    </script>
